name: ðŸ”„ Backup AutomÃ¡tico Supabase DB

on:
  schedule:
    - cron: '0 8 * * *'  # 2:00 AM MÃ©xico
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“ Crear carpeta backups
        run: mkdir -p backups

      - name: ðŸ“… Generar nombre del backup
        run: |
          echo "BACKUP_DATE=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "BACKUP_DATE_SIMPLE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: ðŸ—ï¸ Backup de Schema
        run: |
          export PGCONNECT_TIMEOUT=30
          pg_dump "${{ secrets.SUPABASE_DB_URL }}" \
            --schema-only \
            --no-owner \
            --no-acl \
            --verbose \
            -f backups/schema_${{ env.BACKUP_DATE }}.sql
        env:
          PGSSLMODE: require

      - name: ðŸ’¾ Backup de Datos
        run: |
          export PGCONNECT_TIMEOUT=30
          pg_dump "${{ secrets.SUPABASE_DB_URL }}" \
            --data-only \
            --no-owner \
            --no-acl \
            --verbose \
            -f backups/data_${{ env.BACKUP_DATE }}.sql
        env:
          PGSSLMODE: require

      - name: ðŸ“ Crear README del backup
        run: |
          cat > backups/README_${{ env.BACKUP_DATE }}.md << 'EOF'
          # ðŸ”„ Backup Acrux-Bio - ${{ env.BACKUP_DATE_SIMPLE }}

          ## ðŸ“Š InformaciÃ³n del Backup

          - **Fecha:** ${{ env.BACKUP_DATE }}
          - **Sistema:** Acrux-Bio
          - **Cliente:** Elefante Verde

          ## ðŸ“¦ Archivos Incluidos

          1. `schema_${{ env.BACKUP_DATE }}.sql` - Estructura de tablas
          2. `data_${{ env.BACKUP_DATE }}.sql` - Todos los datos

          ## ðŸ”„ CÃ³mo Restaurar

          ```bash
          # Restaurar schema
          psql "$SUPABASE_DB_URL" < schema_${{ env.BACKUP_DATE }}.sql
          
          # Restaurar datos
          psql "$SUPABASE_DB_URL" < data_${{ env.BACKUP_DATE }}.sql
          ```

          ## âš ï¸ Importante

          - Backup completo del sistema
          - 40,508+ recolecciones incluidas
          
          ---
          *Backup generado por GitHub Actions*
          EOF

      - name: ðŸ—œï¸ Comprimir backups
        run: |
          cd backups
          tar -czf backup_${{ env.BACKUP_DATE }}.tar.gz *.sql *.md
          rm *.sql *.md
          cd ..

      - name: ðŸ§¹ Limpiar backups antiguos
        run: |
          find backups -name "backup_*.tar.gz" -mtime +30 -delete

      - name: ðŸ’¾ Guardar backup en GitHub
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Backup automÃ¡tico - ${{ env.BACKUP_DATE_SIMPLE }}"
          file_pattern: 'backups/*'
          commit_user_name: "Acrux-Bio Backup Bot"
          commit_user_email: "backup@acrux-bio.com"

      - name: âœ… Backup completado
        if: success()
        run: |
          echo "âœ… Backup completado"
          ls -lh backups/

      - name: âŒ Error en backup
        if: failure()
        run: echo "âŒ Error en backup"