name: üîÑ Backup Autom√°tico Supabase DB

# Cu√°ndo se ejecuta:
# 1. Autom√°tico: Todos los d√≠as a las 2:00 AM (hora de M√©xico)
# 2. Manual: Puedes ejecutarlo cuando quieras desde GitHub Actions
on:
  schedule:
    # Cron: "0 8 * * *" = Todos los d√≠as a las 8:00 AM UTC = 2:00 AM M√©xico
    - cron: '0 8 * * *'
  
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el repositorio
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # 2. Instalar Supabase CLI (CORREGIDO v2)
      - name: üîß Instalar Supabase CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/supabase/cli/main/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verificar instalaci√≥n
          $HOME/.local/bin/supabase --version

      # 3. Crear carpeta de backups si no existe
      - name: üìÅ Crear carpeta backups
        run: mkdir -p backups

      # 4. Generar nombre del archivo con fecha
      - name: üìÖ Generar nombre del backup
        run: |
          echo "BACKUP_DATE=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "BACKUP_DATE_SIMPLE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      # 5. Backup: Roles (usuarios de PostgreSQL)
      - name: üë• Backup de Roles
        run: |
          $HOME/.local/bin/supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/roles_${{ env.BACKUP_DATE }}.sql \
            --role-only
        continue-on-error: true

      # 6. Backup: Schema (estructura de tablas)
      - name: üèóÔ∏è Backup de Schema
        run: |
          $HOME/.local/bin/supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/schema_${{ env.BACKUP_DATE }}.sql \
            --schema public

      # 7. Backup: Data (todos los datos)
      - name: üíæ Backup de Datos
        run: |
          $HOME/.local/bin/supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/data_${{ env.BACKUP_DATE }}.sql \
            --use-copy \
            --data-only

      # 8. Crear archivo README con informaci√≥n del backup
      - name: üìù Crear README del backup
        run: |
          cat > backups/README_${{ env.BACKUP_DATE }}.md << EOF
          # üîÑ Backup Acrux-Bio - ${{ env.BACKUP_DATE_SIMPLE }}

          ## üìä Informaci√≥n del Backup

          - **Fecha:** ${{ env.BACKUP_DATE }}
          - **Sistema:** Acrux-Bio
          - **Cliente:** Elefante Verde
          - **Triggered by:** ${{ github.event_name }}

          ## üì¶ Archivos Incluidos

          1. \`roles_${{ env.BACKUP_DATE }}.sql\` - Roles y permisos de PostgreSQL
          2. \`schema_${{ env.BACKUP_DATE }}.sql\` - Estructura de todas las tablas
          3. \`data_${{ env.BACKUP_DATE }}.sql\` - Todos los datos (40,508+ registros)

          ## üîÑ C√≥mo Restaurar

          ### Desde Supabase CLI:

          \`\`\`bash
          # 1. Restaurar schema
          supabase db execute --db-url "\$SUPABASE_DB_URL" -f schema_${{ env.BACKUP_DATE }}.sql

          # 2. Restaurar datos
          supabase db execute --db-url "\$SUPABASE_DB_URL" -f data_${{ env.BACKUP_DATE }}.sql
          \`\`\`

          ### Desde psql:

          \`\`\`bash
          # Restaurar todo de una vez
          psql "\$SUPABASE_DB_URL" < schema_${{ env.BACKUP_DATE }}.sql
          psql "\$SUPABASE_DB_URL" < data_${{ env.BACKUP_DATE }}.sql
          \`\`\`

          ## ‚ö†Ô∏è Importante

          - Este backup incluye TODOS los datos del sistema
          - Total aproximado: 40,508 recolecciones
          - 463 locales, 4 plazas, 11 tipos de residuos
          - Logs de auditor√≠a incluidos

          ---
          *Backup generado autom√°ticamente por GitHub Actions*
          EOF

      # 9. Comprimir backups para ahorrar espacio
      - name: üóúÔ∏è Comprimir backups
        run: |
          cd backups
          tar -czf backup_${{ env.BACKUP_DATE }}.tar.gz *.sql README_${{ env.BACKUP_DATE }}.md
          rm *.sql  # Eliminar archivos SQL individuales, solo guardar el .tar.gz
          cd ..

      # 10. Limpiar backups antiguos (mantener √∫ltimos 30 d√≠as)
      - name: üßπ Limpiar backups antiguos
        run: |
          cd backups
          # Mantener solo archivos de los √∫ltimos 30 d√≠as
          find . -name "backup_*.tar.gz" -mtime +30 -delete
          find . -name "README_*.md" -mtime +30 -delete
          cd ..

      # 11. Commit y push de los backups al repositorio
      - name: üíæ Guardar backup en GitHub
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÑ Backup autom√°tico - ${{ env.BACKUP_DATE_SIMPLE }}"
          file_pattern: 'backups/*'
          commit_user_name: "Acrux-Bio Backup Bot"
          commit_user_email: "backup@acrux-bio.com"
          commit_author: "Acrux-Bio <backup@acrux-bio.com>"

      # 12. Notificaci√≥n de √©xito (opcional)
      - name: ‚úÖ Backup completado
        if: success()
        run: |
          echo "‚úÖ Backup completado exitosamente"
          echo "üìÅ Archivo: backup_${{ env.BACKUP_DATE }}.tar.gz"
          ls -lh backups/

      # 13. Notificaci√≥n de error (si algo falla)
      - name: ‚ùå Error en backup
        if: failure()
        run: |
          echo "‚ùå Error durante el backup"
          echo "Revisa los logs arriba para m√°s detalles"