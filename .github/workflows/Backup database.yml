name: ğŸ”„ Backup AutomÃ¡tico Supabase DB

on:
  schedule:
    - cron: '0 8 * * *'  # 2:00 AM MÃ©xico
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # InstalaciÃ³n manual de Supabase CLI
      - name: ğŸ”§ Instalar Supabase CLI
        run: |
          # Descargar Ãºltima versiÃ³n
          VERSION="1.187.10"
          wget -q "https://github.com/supabase/cli/releases/download/v${VERSION}/supabase_${VERSION}_linux_amd64.tar.gz"
          tar -xzf "supabase_${VERSION}_linux_amd64.tar.gz"
          sudo mv supabase /usr/local/bin/
          sudo chmod +x /usr/local/bin/supabase
          rm "supabase_${VERSION}_linux_amd64.tar.gz"
          # Verificar que existe
          ls -la /usr/local/bin/supabase

      - name: ğŸ“ Crear carpeta backups
        run: mkdir -p backups

      - name: ğŸ“… Generar nombre del backup
        run: |
          echo "BACKUP_DATE=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "BACKUP_DATE_SIMPLE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: ğŸ‘¥ Backup de Roles
        run: |
          supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/roles_${{ env.BACKUP_DATE }}.sql \
            --role-only
        continue-on-error: true

      - name: ğŸ—ï¸ Backup de Schema
        run: |
          supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/schema_${{ env.BACKUP_DATE }}.sql \
            --schema public

      - name: ğŸ’¾ Backup de Datos
        run: |
          supabase db dump \
            --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            -f backups/data_${{ env.BACKUP_DATE }}.sql \
            --use-copy \
            --data-only

      - name: ğŸ“ Crear README del backup
        run: |
          cat > backups/README_${{ env.BACKUP_DATE }}.md << 'EOFMARKER'
          # ğŸ”„ Backup Acrux-Bio - ${{ env.BACKUP_DATE_SIMPLE }}

          ## ğŸ“Š InformaciÃ³n del Backup

          - **Fecha:** ${{ env.BACKUP_DATE }}
          - **Sistema:** Acrux-Bio
          - **Cliente:** Elefante Verde
          - **Triggered by:** ${{ github.event_name }}

          ## ğŸ“¦ Archivos Incluidos

          1. `roles_${{ env.BACKUP_DATE }}.sql` - Roles y permisos
          2. `schema_${{ env.BACKUP_DATE }}.sql` - Estructura de tablas
          3. `data_${{ env.BACKUP_DATE }}.sql` - Todos los datos

          ## ğŸ”„ CÃ³mo Restaurar

          ### Desde Supabase CLI:
          ```bash
          supabase db execute --db-url "$SUPABASE_DB_URL" -f schema_${{ env.BACKUP_DATE }}.sql
          supabase db execute --db-url "$SUPABASE_DB_URL" -f data_${{ env.BACKUP_DATE }}.sql
          ```

          ### Desde psql:
          ```bash
          psql "$SUPABASE_DB_URL" < schema_${{ env.BACKUP_DATE }}.sql
          psql "$SUPABASE_DB_URL" < data_${{ env.BACKUP_DATE }}.sql
          ```

          ## âš ï¸ Importante

          - Backup completo del sistema Acrux-Bio
          - 40,508+ recolecciones
          - 463 locales, 4 plazas, 11 tipos de residuos
          - Logs de auditorÃ­a incluidos

          ---
          *Backup generado automÃ¡ticamente por GitHub Actions*
          EOFMARKER

      - name: ğŸ—œï¸ Comprimir backups
        run: |
          cd backups
          tar -czf backup_${{ env.BACKUP_DATE }}.tar.gz *.sql README_${{ env.BACKUP_DATE }}.md
          rm *.sql
          cd ..

      - name: ğŸ§¹ Limpiar backups antiguos
        run: |
          cd backups
          find . -name "backup_*.tar.gz" -mtime +30 -delete
          find . -name "README_*.md" -mtime +30 -delete
          cd ..

      - name: ğŸ’¾ Guardar backup en GitHub
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Backup automÃ¡tico - ${{ env.BACKUP_DATE_SIMPLE }}"
          file_pattern: 'backups/*'
          commit_user_name: "Acrux-Bio Backup Bot"
          commit_user_email: "backup@acrux-bio.com"
          commit_author: "Acrux-Bio <backup@acrux-bio.com>"

      - name: âœ… Backup completado
        if: success()
        run: |
          echo "âœ… Backup completado exitosamente"
          echo "ğŸ“ Archivo: backup_${{ env.BACKUP_DATE }}.tar.gz"
          ls -lh backups/

      - name: âŒ Error en backup
        if: failure()
        run: |
          echo "âŒ Error durante el backup"
          echo "Revisa los logs arriba para mÃ¡s detalles"